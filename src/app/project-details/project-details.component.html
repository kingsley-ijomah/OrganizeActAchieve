<div class="project-details-container" *ngIf="project; else notfound">
  <header class="header">
    <a routerLink="/projects" class="back-link"><span class="material-icons">arrow_back</span> Projects</a>
    <ng-container *ngIf="!editingTitle; else editing">
      <h1 class="title" (click)="startEditTitle()" title="Click to edit">{{ project.name }}</h1>
    </ng-container>
    <ng-template #editing>
      <div class="title-edit">
        <input class="title-input" [(ngModel)]="editableTitle" (keydown.enter)="saveTitle()" (keydown.escape)="cancelEditTitle()" />
        <div class="title-actions">
          <button class="mini-btn" type="button" (click)="saveTitle()"><span class="material-icons">check</span></button>
          <button class="mini-btn" type="button" (click)="cancelEditTitle()"><span class="material-icons">close</span></button>
        </div>
      </div>
    </ng-template>
  </header>

  <section class="summary">
    <app-progress-stat
      label="Tasks"
      [completed]="project.completedTasks"
      [total]="project.totalTasks"
    ></app-progress-stat>
    <button class="filter-btn" type="button" (click)="openFilter()" aria-label="Filter">
      <span class="material-icons">filter_list</span>
    </button>
  </section>

  <div class="selection-bar" *ngIf="hasSelectedTasks">
    <span class="selection-count">{{ selectedCount }} selected</span>
    <div class="selection-actions">
      <button class="selection-btn complete-btn" type="button" (click)="markSelectedAsComplete()" aria-label="Mark as complete">
        <span class="material-icons">check</span>
        <span>Mark Done</span>
      </button>
      <button class="selection-btn cancel-btn" type="button" (click)="clearSelection()" aria-label="Clear selection">
        <span class="material-icons">close</span>
        <span>Cancel</span>
      </button>
    </div>
  </div>

  <section class="tasks">
    <ul class="task-list">
      <li *ngFor="let t of filteredTasks" class="task-item" [class.completed]="t.status==='completed'" [class.selecting]="hasSelectedTasks" (click)="!hasSelectedTasks && openTaskModal(t)">
        <button class="icon-btn" type="button" (click)="toggleSelect(t.id, $event)" [class.selected]="isSelected(t.id)"><span class="material-icons">{{ isSelected(t.id) ? 'check_box' : (t.status === 'completed' ? 'check_box' : 'check_box_outline_blank') }}</span></button>
        <div class="task-main">
          <div class="title-row">
            <span class="task-title">{{ t.title }}</span>
          </div>
          <div class="task-description" *ngIf="t.description">
            {{ t.description }}
          </div>
          <div class="meta-row">
            <div class="chips-wrapper">
              <div class="chips">
                <span *ngIf="t.status" class="chip status-{{ t.status }}">{{ getStatusLabel(t.status) }}</span>
                <span *ngIf="t.context" class="chip">&#64;{{ t.context }}</span>
                <span *ngIf="t.priority" class="chip priority-{{ t.priority }}">{{ t.priority | titlecase }}</span>
                <span *ngIf="t.dueDate" class="chip due">{{ isToday(t.dueDate) ? 'Today' : (t.dueDate | date:'MMM d') }}</span>
              </div>
              <div class="pomodoros" *ngIf="t.pomodorosPlanned">
                <span class="tomato-icon completed" *ngFor="let i of getArray(t.pomodorosDone || 0)">üçÖ</span>
                <span class="tomato-icon remaining" *ngFor="let i of getArray((t.pomodorosPlanned || 0) - (t.pomodorosDone || 0))">üçÖ</span>
              </div>
            </div>
          </div>
        </div>
      </li>
      <li *ngIf="!filteredTasks.length" class="empty">No tasks for this filter.</li>
    </ul>
  </section>
</div>

<ng-template #notfound>
  <div class="not-found">
    <a routerLink="/projects" class="back-link"><span class="material-icons">arrow_back</span> Projects</a>
    <p>Project not found.</p>
  </div>
</ng-template>

<div class="bottom-spacer"></div>

<app-number-adjust-modal
  [isOpen]="showAdjust"
  [title]="adjustTitle"
  [label]="adjustLabel"
  [value]="adjustValue"
  [min]="adjustMin"
  [max]="adjustMax"
  [step]="adjustStep"
  [suffix]="adjustSuffix"
  (save)="saveAdjust($event)"
  (close)="closeAdjust()"
></app-number-adjust-modal>

<app-task-edit-modal
  [isOpen]="taskModalOpen"
  [model]="taskModel"
  (save)="saveTaskModal($event)"
  (close)="closeTaskModal()"
></app-task-edit-modal>

<app-task-create-modal
  [isOpen]="createModalOpen"
  [model]="createModel"
  (save)="saveCreateModal($event)"
  (close)="closeCreateModal()"
></app-task-create-modal>

<app-task-filter
  [value]="filter"
  [isOpen]="showFilter"
  (change)="onFilterChange($event)"
  (close)="closeFilter()"
></app-task-filter>

<app-confirm-modal
  [isOpen]="showConfirmComplete"
  [title]="'Mark ' + selectedCount + ' task' + (selectedCount > 1 ? 's' : '') + ' as done?'"
  message="This will mark the selected task(s) as completed."
  confirmLabel="Mark Done"
  cancelLabel="Cancel"
  (confirm)="confirmComplete()"
  (cancel)="cancelComplete()"
></app-confirm-modal>

<button class="fab" type="button" (click)="openCreateModal()" *ngIf="project && !hasSelectedTasks" aria-label="Create new task">
  <span class="material-icons">add</span>
</button>
