<div class="project-details-container" *ngIf="project; else notfound">
  <header class="header">
    <a routerLink="/projects" class="back-link"><span class="material-icons">arrow_back</span> Projects</a>
    <ng-container *ngIf="!editingTitle; else editing">
      <h1 class="title" (click)="startEditTitle()" title="Click to edit">{{ project.name }}</h1>
    </ng-container>
    <ng-template #editing>
      <div class="title-edit">
        <input class="title-input" [(ngModel)]="editableTitle" (keydown.enter)="saveTitle()" (keydown.escape)="cancelEditTitle()" />
        <div class="title-actions">
          <button class="mini-btn" type="button" (click)="saveTitle()"><span class="material-icons">check</span></button>
          <button class="mini-btn" type="button" (click)="cancelEditTitle()"><span class="material-icons">close</span></button>
        </div>
      </div>
    </ng-template>
  </header>

  <section class="summary">
    <app-progress-stat
      label="Tasks"
      [completed]="project.completedTasks"
      [total]="project.totalTasks"
    ></app-progress-stat>
  </section>

  <section class="tasks">
    <div class="filter-bar">
      <button type="button" class="seg-btn" [class.active]="filter==='all'" (click)="filter='all'">All</button>
      <button type="button" class="seg-btn" [class.active]="filter==='today'" (click)="filter='today'">Today</button>
      <button type="button" class="seg-btn" [class.active]="filter==='week'" (click)="filter='week'">This Week</button>
      <button type="button" class="seg-btn" [class.active]="filter==='no_due'" (click)="filter='no_due'">No Due</button>
      <button type="button" class="seg-btn" [class.active]="filter==='completed'" (click)="filter='completed'">Completed</button>
    </div>
    <ul class="task-list">
      <li *ngFor="let t of filteredTasks" class="task-item" [class.completed]="t.status==='completed'">
        <button class="icon-btn" type="button" (click)="toggleComplete(t)"><span class="material-icons">{{ t.status === 'completed' ? 'check_circle' : 'radio_button_unchecked' }}</span></button>
        <div class="task-main">
          <div class="title-row">
            <span class="task-title">{{ t.title }}</span>
            <button class="view-link" type="button" (click)="openTaskModal(t)">View</button>
          </div>
          <div class="meta-row">
            <div class="chips">
              <span *ngIf="t.context" class="chip">&#64;{{ t.context }}</span>
              <span *ngIf="t.priority" class="chip priority-{{ t.priority }}">{{ t.priority | titlecase }}</span>
              <span *ngIf="t.dueDate" class="chip due">{{ isToday(t.dueDate) ? 'Today' : (t.dueDate | date:'MMM d') }}</span>
            </div>
            <div class="pomodoros" *ngIf="t.pomodorosPlanned">
              <span class="tomato-icon completed" *ngFor="let i of getArray(t.pomodorosDone || 0)">üçÖ</span>
              <span class="tomato-icon remaining" *ngFor="let i of getArray((t.pomodorosPlanned || 0) - (t.pomodorosDone || 0))">üçÖ</span>
            </div>
          </div>
          <div class="actions" *ngIf="filter!=='completed'">
            <button class="mini-btn" type="button" title="Defer" (click)="openAdjustForDefer(t)"><span class="material-icons">schedule</span></button>
            <button class="mini-btn" type="button" title="Planned Pomodoros" (click)="openAdjustForPlanned(t)"><span class="material-icons">timer</span></button>
            <button class="mini-btn" type="button" title="Completed Pomodoros" (click)="openAdjustForDone(t)"><span class="material-icons">check</span></button>
          </div>
        </div>
      </li>
      <li *ngIf="!filteredTasks.length" class="empty">No tasks for this filter.</li>
    </ul>
  </section>
</div>

<ng-template #notfound>
  <div class="not-found">
    <a routerLink="/projects" class="back-link"><span class="material-icons">arrow_back</span> Projects</a>
    <p>Project not found.</p>
  </div>
</ng-template>

<div class="bottom-spacer"></div>

<app-number-adjust-modal
  [isOpen]="showAdjust"
  [title]="adjustTitle"
  [label]="adjustLabel"
  [value]="adjustValue"
  [min]="adjustMin"
  [max]="adjustMax"
  [step]="adjustStep"
  [suffix]="adjustSuffix"
  (save)="saveAdjust($event)"
  (close)="closeAdjust()"
></app-number-adjust-modal>

<app-task-edit-modal
  [isOpen]="taskModalOpen"
  [model]="taskModel"
  (save)="saveTaskModal($event)"
  (close)="closeTaskModal()"
></app-task-edit-modal>

<app-task-create-modal
  [isOpen]="createModalOpen"
  [model]="createModel"
  (save)="saveCreateModal($event)"
  (close)="closeCreateModal()"
></app-task-create-modal>

<button class="fab" type="button" (click)="openCreateModal()" *ngIf="project" aria-label="Create new task">
  <span class="material-icons">add</span>
</button>
